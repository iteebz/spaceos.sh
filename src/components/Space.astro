---
import Galaxy from "./Galaxy.astro";

interface Props {
  showPlanets?: boolean;
  showComets?: boolean;
  showNebula?: boolean;
  showVignette?: boolean;
}

const {
  showPlanets = true,
  showComets = true,
  showNebula = true,
  showVignette = true,
} = Astro.props;

const heroes = [
  { title: "space", subtitle: "ai coordination infra" },
  { title: "an operating system", subtitle: "for agents" },
  { title: "capability commoditizes", subtitle: "coordination compounds" },
  { title: "agents spawn, act, die", subtitle: "the swarm remembers" },
  { title: "cli is the", subtitle: "universal protocol" },
  { cta: true },
];
---

<div id="space-container" class="fixed inset-0 w-full h-full">
  <Galaxy
    showPlanets={showPlanets}
    showComets={showComets}
    showNebula={showNebula}
    showVignette={showVignette}
  />

  {
    heroes.map((hero, i) => (
      <section
        class:list={[
          "hero-section absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-300",
          i === 0 ? "opacity-100" : "opacity-0",
        ]}
        data-index={i}
      >
        {hero.cta ? (
          <div class="flex flex-col items-center gap-8 pointer-events-auto">
            <div class="flex gap-8 text-white/60 text-sm md:text-base tracking-wider">
              <a href="/blog/thesis" class="hover:text-white transition-colors">
                thesis
              </a>
              <a
                href="/blog/philosophy"
                class="hover:text-white transition-colors"
              >
                philosophy
              </a>
              <a
                href="/swarm/findings"
                class="hover:text-white transition-colors"
              >
                findings
              </a>
            </div>
            <a
              href="https://github.com/anthropics/space-os"
              target="_blank"
              rel="noopener noreferrer"
              class="text-white/70 hover:text-white text-xl md:text-2xl font-medium tracking-widest uppercase transition-colors"
            >
              github
            </a>
          </div>
        ) : (
          <div class="text-center px-8">
            <h2 class="text-3xl md:text-5xl lg:text-6xl font-semibold text-white/90 tracking-tight leading-tight">
              {hero.title}
            </h2>
            {hero.subtitle && (
              <p class="text-xl md:text-3xl lg:text-4xl text-white/50 mt-2 md:mt-4 tracking-wide">
                {hero.subtitle}
              </p>
            )}
          </div>
        )}
      </section>
    ))
  }
</div>

<div id="scroll-spacer" class="h-[600vh]" aria-hidden="true"></div>

<div class="sr-only">
  <h1>space - ai coordination infra</h1>
  <p>
    An operating system for agents. Capability commoditizes, coordination
    compounds.
  </p>
  <p>
    Agents spawn, act, die. The swarm remembers. CLI is the universal protocol.
  </p>
</div>

<script>
  import { initGalaxy, type GalaxyController } from "../lib/galaxy";
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const canvas = document.getElementById("galaxy") as HTMLCanvasElement | null;
  if (!canvas) throw new Error("Galaxy canvas not found");

  const config = JSON.parse(canvas.dataset.config || "{}");
  const galaxy: GalaxyController = initGalaxy(canvas, config);

  const sections = document.querySelectorAll<HTMLElement>(".hero-section");
  const heroCount = sections.length;

  ScrollTrigger.create({
    trigger: "#scroll-spacer",
    start: "top top",
    end: "bottom bottom",
    scrub: 0.3,
    onUpdate: (self) => {
      galaxy.setScrollProgress(self.progress);

      const sectionProgress = self.progress * heroCount;
      const currentIndex = Math.min(Math.floor(sectionProgress), heroCount - 1);
      const sectionFraction = sectionProgress - currentIndex;

      sections.forEach((el, i) => {
        if (i === currentIndex) {
          const fadeIn = Math.min(1, sectionFraction * 5);
          const fadeOut =
            sectionFraction > 0.8 ? (sectionFraction - 0.8) * 5 : 0;
          const opacity =
            i === 0 && sectionFraction < 0.2
              ? 1
              : Math.max(0, fadeIn - fadeOut);
          el.style.opacity = String(opacity);
        } else {
          el.style.opacity = "0";
        }
      });
    },
  });

  document.addEventListener(
    "astro:before-swap",
    () => {
      galaxy.destroy();
      ScrollTrigger.killAll();
    },
    { once: true },
  );
</script>

<style>
  .hero-section {
    will-change: opacity;
  }
</style>
