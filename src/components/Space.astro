---
import Galaxy from "./Galaxy.astro";
import fs from "node:fs";
import path from "node:path";

interface Props {
  showPlanets?: boolean;
  showComets?: boolean;
  showNebula?: boolean;
  showVignette?: boolean;
}

const {
  showPlanets = true,
  showComets = true,
  showNebula = true,
  showVignette = true,
} = Astro.props;

const findingsDir = path.join(process.cwd(), "docs", "findings");
const findingsCount = fs
  .readdirSync(findingsDir)
  .filter((f) => f.endsWith(".md")).length;

const heroes = [
  { title: "space", subtitle: "ai coordination substrate", isHero: true },
  { title: "stateless agents", subtitle: "stateful swarm" },
  { title: "capability commoditizes", subtitle: "coordination compounds" },
  { title: "agents spawn, act, die", subtitle: "the swarm remembers" },
  { cta: true },
];
---

<div id="space-container" class="fixed inset-0 w-full h-full">
  <Galaxy
    showPlanets={showPlanets}
    showComets={showComets}
    showNebula={showNebula}
    showVignette={showVignette}
  />

  {
    heroes.map((hero, i) => (
      <section
        class:list={[
          "hero-section absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-300",
          i === 0 ? "opacity-100" : "opacity-0",
        ]}
        data-index={i}
      >
        {hero.cta ? (
          <div class="flex flex-col items-center gap-12 pointer-events-auto max-w-2xl px-8">
            <div id="live-stats" class="flex gap-6 text-white/40 text-xs tracking-wider font-mono opacity-0 transition-opacity duration-500"></div>
            <div class="text-center">
              <p class="text-white/50 text-sm md:text-base tracking-wide mb-6">
                multi-agent research artifacts
              </p>
              <a
                href="/swarm/findings"
                class="inline-block text-white text-lg md:text-xl font-medium hover:text-white/80 transition-colors border-b border-white/30 hover:border-white/60 pb-1"
              >
                {findingsCount} findings from the swarm
              </a>
            </div>
            <div class="flex gap-8 text-white/40 text-sm tracking-wider">
              <a
                href="/docs/thesis"
                class="hover:text-white/70 transition-colors"
              >
                thesis
              </a>
              <a
                href="/docs/philosophy"
                class="hover:text-white/70 transition-colors"
              >
                philosophy
              </a>
            </div>
          </div>
        ) : (
          <div class="text-center px-8">
            <h2 class:list={[
              "font-semibold text-white/90 tracking-tight leading-tight",
              hero.isHero ? "text-4xl md:text-6xl lg:text-7xl" : "text-2xl md:text-4xl lg:text-5xl"
            ]}>
              {hero.title}
            </h2>
            {hero.subtitle && (
              <p class:list={[
                "text-white/40 mt-2 md:mt-3 tracking-wide",
                hero.isHero ? "text-lg md:text-2xl lg:text-3xl" : "text-xl md:text-3xl lg:text-4xl"
              ]}>
                {hero.subtitle}
              </p>
            )}
          </div>
        )}
      </section>
    ))
  }
</div>

<div id="scroll-spacer" class="h-[500vh]" aria-hidden="true"></div>

<div class="sr-only">
  <h1>space - ai coordination infra</h1>
  <p>
    An operating system for agents. Capability commoditizes, coordination
    compounds.
  </p>
  <p>
    Agents spawn, act, die. The swarm remembers. CLI is the universal protocol.
  </p>
</div>

<script>
  import { initGalaxy, type GalaxyController } from "../lib/galaxy";
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const canvas = document.getElementById("galaxy") as HTMLCanvasElement | null;
  if (!canvas) throw new Error("Galaxy canvas not found");

  const config = JSON.parse(canvas.dataset.config || "{}");
  const galaxy: GalaxyController = initGalaxy(canvas, config);

  const sections = document.querySelectorAll<HTMLElement>(".hero-section");
  const heroCount = sections.length;

  ScrollTrigger.create({
    trigger: "#scroll-spacer",
    start: "top top",
    end: "bottom bottom",
    scrub: 0.3,
    onUpdate: (self) => {
      galaxy.setScrollProgress(self.progress);

      const sectionProgress = self.progress * heroCount;
      const currentIndex = Math.min(Math.floor(sectionProgress), heroCount - 1);
      const sectionFraction = sectionProgress - currentIndex;

      sections.forEach((el, i) => {
        if (i === currentIndex) {
          const isLast = i === heroCount - 1;
          const fadeIn = Math.min(1, sectionFraction * 5);
          const fadeOut =
            !isLast && sectionFraction > 0.8 ? (sectionFraction - 0.8) * 5 : 0;
          const opacity =
            i === 0 && sectionFraction < 0.2
              ? 1
              : Math.max(0, fadeIn - fadeOut);
          el.style.opacity = String(opacity);
        } else {
          el.style.opacity = "0";
        }
      });
    },
  });

  document.addEventListener(
    "astro:before-swap",
    () => {
      galaxy.destroy();
      ScrollTrigger.killAll();
    },
    { once: true },
  );

  fetch("/stats.json")
    .then((r) => (r.ok ? r.json() : null))
    .then((stats) => {
      if (!stats) return;
      const el = document.getElementById("live-stats");
      if (!el) return;
      el.innerHTML = [
        `<span>${stats.spawns_24h} spawns/24h</span>`,
        `<span>${stats.insights.toLocaleString()} insights</span>`,
        `<span>${stats.decisions} decisions</span>`,
      ].join("");
      el.style.opacity = "1";
    })
    .catch(() => {});
</script>

<style>
  .hero-section {
    will-change: opacity;
  }
</style>
